<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pro Account</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

  <!-- Bonus Banner (Top Fixed) -->
  <div id="bonusBanner" class="hidden fixed top-0 left-0 w-full text-white z-50"></div>

  <main class="max-w-4xl mx-auto px-4 py-24">
    <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-100 flex flex-col justify-between">
      <div>
        <h2 class="text-xl font-semibold mb-4 text-blue-700">üíé Pro Account Status</h2>
        <p><strong>Active:</strong> <span id="isProStatus">Loading...</span></p>
        <p><strong>Expires On:</strong> <span id="proExpiryDate">-</span></p>
        <hr class="my-3" />
        <h3 class="font-semibold text-lg text-blue-600 mb-2">Current Pro Account Plan</h3>
        <ul class="list-disc list-inside space-y-1 text-gray-700 mb-6">
          <li>Activation Cost: ‡ß≥<span id="proActivationCost">...</span></li>
          <li>Daily Bonus: ‡ß≥<span id="proDailyBonus">...</span></li>
          <li>Validity: <span id="proValidity">...</span> days</li>
        </ul>
      </div>

      <button
        id="activateProBtn"
        onclick="activateProAccount()"
        class="bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
      >
        Activate Pro Account
      </button>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCkYWvYNsg2-CR88Js6gcP2nXfvwI4TW30",
      authDomain: "bdwork-346d3.firebaseapp.com",
      projectId: "bdwork-346d3",
      storageBucket: "bdwork-346d3.appspot.com",
      messagingSenderId: "900963179093",
      appId: "1:900963179093:web:81e42d67bb31d603cc92dc",
      measurementId: "G-FM1YJ8E5GK"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUserData = null;
    let proSettings = null;
    let pendingBonus = 0;

    onAuthStateChanged(auth, async (user) => {
      if (!user) return window.location.href = "login.html";

      try {
        const userDocRef = doc(db, "users", user.uid);
        const userDoc = await getDoc(userDocRef);
        if (!userDoc.exists()) throw new Error("User data not found");

        const data = userDoc.data();
        currentUserData = { uid: user.uid, ...data };

        const proSettingsDocRef = doc(db, "settings", "proAccount");
        const proSettingsDocSnap = await getDoc(proSettingsDocRef);
        proSettings = proSettingsDocSnap.exists() ? proSettingsDocSnap.data() : null;

        document.getElementById("proActivationCost").innerText = proSettings?.activationCost ?? "-";
        document.getElementById("proDailyBonus").innerText = proSettings?.dailyBonus ?? "-";
        document.getElementById("proValidity").innerText = proSettings?.validity ?? "-";

        let isProActive = false;
        if (data.isPro === true && data.proExpiryTimestamp) {
          const expiryDate = data.proExpiryTimestamp.toDate
            ? data.proExpiryTimestamp.toDate()
            : new Date(data.proExpiryTimestamp);
          const now = new Date();

          if (expiryDate > now) {
            isProActive = true;
            document.getElementById("proExpiryDate").innerText = expiryDate.toLocaleDateString();
            await showBonusBannerIfEligible(userDocRef, data, proSettings);
          } else {
            await updateDoc(userDocRef, { isPro: false, proExpiryTimestamp: null });
            document.getElementById("proExpiryDate").innerText = "-";
            currentUserData.isPro = false;
          }
        } else {
          document.getElementById("proExpiryDate").innerText = "-";
        }

        document.getElementById("isProStatus").innerText = isProActive ? "Yes" : "No";

        const activateBtn = document.getElementById("activateProBtn");
        activateBtn.disabled = isProActive;
        activateBtn.innerText = isProActive ? "Pro Account Active" : "Activate Pro Account";

      } catch (error) {
        alert("Failed to load Pro Account data: " + error.message);
      }
    });

    window.activateProAccount = async function () {
      if (!currentUserData || !proSettings) return alert("Data not loaded yet.");

      const now = new Date();
      const expiryDate = new Date(now.getTime() + (proSettings.validity || 0) * 24 * 60 * 60 * 1000);
      const expiryTimestamp = Timestamp.fromDate(expiryDate);

      const cost = proSettings.activationCost || 0;
      const bonus = proSettings.dailyBonus || 0;
      const currentBalance = currentUserData.balance || 0;

      if (currentBalance < cost) {
        alert(`Insufficient balance. You need ‡ß≥${cost} to activate Pro Account.`);
        return;
      }

      try {
        const userDocRef = doc(db, "users", currentUserData.uid);

        await updateDoc(userDocRef, {
          balance: currentBalance - cost,
          isPro: true,
          proExpiryTimestamp: expiryTimestamp,
        });

        currentUserData = {
          ...currentUserData,
          balance: currentBalance - cost,
          isPro: true,
          proExpiryTimestamp: expiryTimestamp,
        };

        document.getElementById("isProStatus").innerText = "Yes";
        document.getElementById("proExpiryDate").innerText = expiryDate.toLocaleDateString();

        const activateBtn = document.getElementById("activateProBtn");
        activateBtn.disabled = true;
        activateBtn.innerText = "Pro Account Active";

        pendingBonus = bonus;
        showBonusBanner(bonus);

      } catch (error) {
        alert("Failed to activate Pro Account: " + error.message);
      }
    };

    window.receiveBonus = async function () {
      if (!currentUserData || pendingBonus <= 0) return;

      try {
        const userDocRef = doc(db, "users", currentUserData.uid);
        const newBalance = (currentUserData.balance || 0) + pendingBonus;

        await updateDoc(userDocRef, {
          balance: newBalance,
          lastBonusClaim: Timestamp.fromDate(new Date()),
        });

        currentUserData.balance = newBalance;
        currentUserData.lastBonusClaim = new Date();

        document.getElementById("bonusBanner").classList.add("hidden");
        alert(`‡ß≥${pendingBonus} bonus received successfully!`);
        pendingBonus = 0;
      } catch (err) {
        alert("Failed to receive bonus: " + err.message);
      }
    };

    async function showBonusBannerIfEligible(userDocRef, userData, proSettings) {
      const now = new Date();
      const lastClaim = userData.lastBonusClaim ?
        (userData.lastBonusClaim.toDate ? userData.lastBonusClaim.toDate() : new Date(userData.lastBonusClaim)) : null;

      if (!lastClaim || !isSameDay(now, lastClaim)) {
        pendingBonus = proSettings.dailyBonus || 0;
        showBonusBanner(pendingBonus);
      }
    }

    function showBonusBanner(amount) {
      const banner = document.getElementById("bonusBanner");
      banner.innerHTML = `
        <div class="w-full px-4 py-4 bg-gradient-to-r from-yellow-50 via-white to-yellow-100 border border-yellow-300 rounded-xl shadow-lg flex justify-between items-center animate-fade-in">
  <div class="flex items-center space-x-3 text-yellow-800">
    <div class="text-2xl">üéÅ</div>
    <div class="text-sm sm:text-base font-medium">
      <span class="block sm:inline">You have a bonus of</span>
      <span class="text-orange-600 font-extrabold text-base sm:text-lg">‡ß≥${amount}</span>
      <span class="hidden sm:inline">to claim!</span>
    </div>
  </div>
  <button
    onclick="receiveBonus()"
    class="ml-6 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold px-5 py-2.5 rounded-xl shadow transition duration-200 ease-in-out transform hover:scale-105"
  >
    üéâ Claim Bonus
  </button>
</div>

      `;
      banner.classList.remove("hidden");
    }

    function isSameDay(d1, d2) {
      return d1.getFullYear() === d2.getFullYear() &&
             d1.getMonth() === d2.getMonth() &&
             d1.getDate() === d2.getDate();
    }
  </script>
</body>
</html>
