<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>User Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">

  <main class="max-w-4xl mx-auto py-10 px-4">
    <div class="bg-white p-6 rounded-xl shadow-md">
      <h2 class="text-2xl font-bold text-blue-700 mb-4">üë§ User Dashboard</h2>

      <p><strong>Name:</strong> <span id="userName">Loading...</span></p>
      <p><strong>Balance:</strong> ‡ß≥<span id="userBalance">0</span></p>
      <p><strong>Referral Code:</strong> <span id="refCode">-</span></p>
      <p><strong>Total Referred:</strong> <span id="totalReferred">0</span></p>
      <p><strong>Pro Account:</strong> <span id="isPro">Loading...</span></p>

      <div id="proBonusSection" class="mt-6 hidden">
        <button
          id="claimBonusBtn"
          onclick="claimDailyBonus()"
          class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700"
        >
          üéÅ Receive Daily Bonus
        </button>
      </div>

      <div class="mt-6 space-x-3">
        <a href="deposit.html" class="text-blue-600 underline">üí≥ Deposit</a>
        <a href="withdraw.html" class="text-blue-600 underline">üí∏ Withdraw</a>
        <a href="history.html" class="text-blue-600 underline">üìú History</a>
        <a href="pro.html" class="text-purple-600 underline">üíé Go Pro</a>
      </div>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCkYWvYNsg2-CR88Js6gcP2nXfvwI4TW30",
      authDomain: "bdwork-346d3.firebaseapp.com",
      projectId: "bdwork-346d3",
      storageBucket: "bdwork-346d3.appspot.com",
      messagingSenderId: "900963179093",
      appId: "1:900963179093:web:81e42d67bb31d603cc92dc",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUserData = null;

    onAuthStateChanged(auth, async (user) => {
      if (!user) return window.location.href = "login.html";

      const userDocRef = doc(db, "users", user.uid);
      const userSnap = await getDoc(userDocRef);
      if (!userSnap.exists()) return alert("User data not found.");

      const data = userSnap.data();
      currentUserData = { uid: user.uid, ...data };

      document.getElementById("userName").innerText = data.name || "N/A";
      document.getElementById("userBalance").innerText = data.balance || 0;
      document.getElementById("refCode").innerText = data.refCode || "-";
      document.getElementById("totalReferred").innerText = data.totalReferred || 0;
      document.getElementById("isPro").innerText = data.isPro ? "Yes" : "No";

      // Show bonus claim button if Pro
      if (data.isPro) {
        document.getElementById("proBonusSection").classList.remove("hidden");
      }
    });

    // === Daily Bonus Claim Function ===
    async function claimDailyBonus() {
      if (!currentUserData || !currentUserData.isPro) {
        alert("Only Pro users can claim daily bonus.");
        return;
      }

      const userDocRef = doc(db, "users", currentUserData.uid);
      const userSnap = await getDoc(userDocRef);
      if (!userSnap.exists()) return;

      const data = userSnap.data();
      const lastClaimDate = data.lastBonusClaim?.toDate?.() || new Date(data.lastBonusClaim || 0);
      const today = new Date();

      // Check if already claimed today
      if (isSameDay(today, lastClaimDate)) {
        alert("You have already claimed today's bonus.");
        return;
      }

      const settingsSnap = await getDoc(doc(db, "settings", "proAccount"));
      if (!settingsSnap.exists()) return alert("Pro settings not found.");
      const settings = settingsSnap.data();

      const bonus = settings.dailyBonus || 0;
      const newBalance = (data.balance || 0) + bonus;

      await updateDoc(userDocRef, {
        balance: newBalance,
        lastBonusClaim: Timestamp.fromDate(today),
      });

      document.getElementById("userBalance").innerText = newBalance;
      alert(`‡ß≥${bonus} daily bonus credited!`);
    }

    function isSameDay(d1, d2) {
      return d1.getFullYear() === d2.getFullYear() &&
             d1.getMonth() === d2.getMonth() &&
             d1.getDate() === d2.getDate();
    }
  </script>
</body>
</html>
